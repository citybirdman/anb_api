import frappe
import json
import requests
from frappe.utils import add_days, today, nowtime
def get_account_statment(account_number, settings, try_again=True, headers={}):
    from_date = add_days(today(), -7) 
    response = requests.get(f"https://test-api.anb.com.sa/v2/report/account/statement?accountNumber={account_number}&offset=Offset&type=JSON&fromDate={from_date}", headers=headers)
    if response.status_code != 200:
        if try_again:
            get_account_statment(account_number, settings, False)
        else:
            return {"account_number": account_number, "completed": False}
    else:
        return json.loads(response.text)
    
@frappe.whitelist()
def get_statments():
    return [{'accountNumber': '0108095164500016', 'fromDate': '2024-01-22', 'toDate': '2024-01-29', 'numberOfRecords': 20, 'completed': False, 'offset': '22-01-2024SDC231315      2   22-01-202417:45:270000000014966027.80', 'broughtFrwdBalance': {'amount': 14965741.6, 'currencyCode': 'SAR'}, 'openingClrBalance': {'amount': 14965741.6}, 'pageOpenBalance': {'amount': 14965741.6, 'currencyCode': 'SAR'}, 'closingBalance': {'amount': 14966027.8, 'currencyCode': 'SAR'}, 'statement': {'transactions': [{'postDate': '2024-01-22', 'postingTime': '15:50:38', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 150, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00072997-مدفوعات تجارية', 'narr2': '01080910016', 'narr3': '1100893132'}, 'refNum': 'SDC231255', 'counter': '1', 'stmt': 'Y', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14965891.6, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'samaNarr': 'BT00072997-مدفوعات تجارية010809100161100893132', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-22', 'postingTime': '15:51:11', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 146.55, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00072998-مدفوعات تجارية', 'narr2': '01080910016', 'narr3': '1100893133'}, 'refNum': 'SDC231257', 'counter': '2', 'stmt': 'Y', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966038.15, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'samaNarr': 'BT00072998-مدفوعات تجارية010809100161100893133', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-22', 'postingTime': '16:44:30', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073000', 'narr2': 'SA5020000003031531929940', 'narr3': '284'}, 'refNum': 'SDC231273', 'counter': '3', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966028.15, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073000SA5020000003031531929940284', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23127422-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '16:44:48', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B26011641379008', 'narr2': 'BT00073000', 'narr3': 'AC03'}, 'refNum': 'SDC231274', 'counter': '4', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966037, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B26011641379008BT00073000AC03', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23127422-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '16:48:57', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073001', 'narr2': 'SA0915000609128913370007', 'narr3': '285'}, 'refNum': 'SDC231296', 'counter': '5', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966027, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073001SA0915000609128913370007285', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23127422-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '16:49:30', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073002', 'narr2': 'SA1205000068200032472000', 'narr3': '286'}, 'refNum': 'SDC231297', 'counter': '6', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966017, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073002SA1205000068200032472000286', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23129822-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '16:49:52', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B99511647379134', 'narr2': 'BT00073002', 'narr3': 'AC03'}, 'refNum': 'SDC231298', 'counter': '7', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966025.85, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B99511647379134BT00073002AC03', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23129922-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '16:49:53', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B73311646379119', 'narr2': 'BT00073001', 'narr3': 'DS24'}, 'refNum': 'SDC231299', 'counter': '8', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966034.7, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B73311646379119BT00073001DS24', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23129922-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:28:43', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073003', 'narr2': 'SA2910000005100003144805', 'narr3': '0'}, 'refNum': 'SDC231304', 'counter': '9', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966024.7, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073003SA29100000051000031448050', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23130522-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:29:09', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B50611726380075', 'narr2': 'BT00073003', 'narr3': 'DS24'}, 'refNum': 'SDC231305', 'counter': '10', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966033.55, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B50611726380075BT00073003DS24', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23130522-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:36:55', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073004', 'narr2': 'SA2910000005100003144805', 'narr3': '292'}, 'refNum': 'SDC231306', 'counter': '11', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966023.55, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073004SA2910000005100003144805292', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23130722-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:37:16', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B07711734380270', 'narr2': 'BT00073004', 'narr3': 'AC03'}, 'refNum': 'SDC231307', 'counter': '12', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966032.4, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B07711734380270BT00073004AC03', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23130722-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:37:38', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073005', 'narr2': 'SA2910000005100003144805', 'narr3': '293'}, 'refNum': 'SDC231308', 'counter': '13', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966022.4, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073005SA2910000005100003144805293', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23130922-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:38:19', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B61411735380291', 'narr2': 'BT00073005', 'narr3': 'DS24'}, 'refNum': 'SDC231309', 'counter': '14', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966031.25, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B61411735380291BT00073005DS24', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23130922-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:39:19', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073006', 'narr2': 'SA4345000000051058642001', 'narr3': '294'}, 'refNum': 'SDC231310', 'counter': '15', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966021.25, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073006SA4345000000051058642001294', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23130922-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:40:01', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073007', 'narr2': 'SA1205000068200032472000', 'narr3': '295'}, 'refNum': 'SDC231311', 'counter': '16', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966011.25, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073007SA1205000068200032472000295', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23131222-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:40:22', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B28211737380357', 'narr2': 'BT00073007', 'narr3': 'AC03'}, 'refNum': 'SDC231312', 'counter': '17', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966020.1, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B28211737380357BT00073007AC03', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23131322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:40:24', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B26811736380336', 'narr2': 'BT00073006', 'narr3': 'AC03'}, 'refNum': 'SDC231313', 'counter': '18', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966028.95, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B26811736380336BT00073006AC03', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23131322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:44:41', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -10, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073008', 'narr2': 'SA7560100011480133684001', 'narr3': '297'}, 'refNum': 'SDC231314', 'counter': '19', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 14966018.95, 'currencyCode': 'SAR'}, 'orderingParty': 'CORPORATE_NAME', 'samaNarr': 'BT00073008SA7560100011480133684001297', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23131522-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '17:45:27', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 8.85, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B64111742380468', 'narr2': 'BT00073008', 'narr3': 'AC03'}, 'refNum': 'SDC231315', 'counter': '20', 'stmt': 'Y', 'srcAcctNum': 'I011660104991051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 14966027.8, 'currencyCode': 'SAR'}, 'beneficiaryName': 'CORPORATE_NAME', 'iban': 'I011660104991051', 'samaNarr': '20240122SAARNBARNB1B64111742380468BT00073008AC03', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}]}}, {'accountNumber': '0108071089680019', 'fromDate': '2024-01-22', 'toDate': '2024-01-29', 'numberOfRecords': 20, 'completed': False, 'offset': '23-01-2024SDC231705      2   23-01-202417:48:0800000000-3494527.81', 'broughtFrwdBalance': {'amount': -3491570.53, 'currencyCode': 'SAR'}, 'openingClrBalance': {'amount': -3491570.53}, 'pageOpenBalance': {'amount': -3491570.53, 'currencyCode': 'SAR'}, 'closingBalance': {'amount': -3494527.81, 'currencyCode': 'SAR'}, 'statement': {'transactions': [{'postDate': '2024-01-22', 'postingTime': '15:01:02', 'valueDate': '2024-01-22', 'type': '59', 'amount': {'amount': -304.6, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'TM-MOB TXN NO : 247081000058', 'narr2': 'Telemoney transactions from Digital'}, 'refNum': 'SDC231239', 'counter': '1', 'stmt': 'Y', 'srcAcctNum': 'I013253401840200', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3491875.13, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I013253401840200', 'samaNarr': 'TM-MOB TXN NO : 247081000058Telemoney transactions from Digital', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '016DC'}, {'postDate': '2024-01-22', 'postingTime': '15:44:25', 'valueDate': '2024-01-22', 'type': '59', 'amount': {'amount': -354.6, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'TM-MOB TXN NO : 247081000059', 'narr2': 'Telemoney transactions from Digital'}, 'refNum': 'SDC231251', 'counter': '2', 'stmt': 'Y', 'srcAcctNum': 'I013253401840200', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3492229.73, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I013253401840200', 'samaNarr': 'TM-MOB TXN NO : 247081000059Telemoney transactions from Digital', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '016DC'}, {'postDate': '2024-01-22', 'postingTime': '15:50:38', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -153.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00072997-مدفوعات تجارية', 'narr2': '01080910016', 'narr3': '1100893132'}, 'refNum': 'SDC231255', 'counter': '3', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3492383.18, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00072997-مدفوعات تجارية010809100161100893132', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-22', 'postingTime': '15:51:11', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -150, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00072998-مدفوعات تجارية', 'narr2': '01080910016', 'narr3': '1100893133'}, 'refNum': 'SDC231257', 'counter': '4', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3492533.18, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00072998-مدفوعات تجارية010809100161100893133', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-22', 'postingTime': '10:11:21', 'valueDate': '2024-01-22', 'type': '59', 'amount': {'amount': -1233.19, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'TM-RIB TXN NO : 241871000004', 'narr2': 'Telemoney transactions from Digital'}, 'refNum': 'SDC231448', 'counter': '5', 'stmt': 'Y', 'srcAcctNum': 'I013253401870200', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3493766.37, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I013253401870200', 'samaNarr': 'TM-RIB TXN NO : 241871000004Telemoney transactions from Digital', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '016DC'}, {'postDate': '2024-01-22', 'postingTime': '10:13:42', 'valueDate': '2024-01-22', 'type': '59', 'amount': {'amount': -379.01, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'TM-RIB TXN NO : 241871000005', 'narr2': 'Telemoney transactions from Digital'}, 'refNum': 'SDC231450', 'counter': '6', 'stmt': 'Y', 'srcAcctNum': 'I013253401870200', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3494145.38, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I013253401870200', 'samaNarr': 'TM-RIB TXN NO : 241871000005Telemoney transactions from Digital', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '016DC'}, {'postDate': '2024-01-22', 'postingTime': '10:14:55', 'valueDate': '2024-01-22', 'type': '59', 'amount': {'amount': -1744.18, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'TM-RIB TXN NO : 241871000006', 'narr2': 'Telemoney transactions from Digital'}, 'refNum': 'SDC231451', 'counter': '7', 'stmt': 'Y', 'srcAcctNum': 'I013253401870200', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3495889.56, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I013253401870200', 'samaNarr': 'TM-RIB TXN NO : 241871000006Telemoney transactions from Digital', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '016DC'}, {'postDate': '2024-01-22', 'postingTime': '11:59:11', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -53.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073038-تحويل بين حساباتي', 'narr2': 'ANB To ANB viban Transfer', 'narr3': '2132376426334243'}, 'refNum': 'SDC231490', 'counter': '8', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3495943.01, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00073038-تحويل بين حساباتيANB To ANB viban Transfer2132376426334243', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-23', 'postingTime': '14:57:07', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': 10000, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073059-تحويل استثماري', 'narr2': 'B2B OUTGOING - 371', 'narr3': '371'}, 'refNum': 'SDC231549', 'counter': '9', 'stmt': 'Y', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': -3485943.01, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00073059-تحويل استثماريB2B OUTGOING - 371371', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-23', 'postingTime': '15:59:18', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': -8003.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073080-تحويل استثماري', 'narr2': 'B2B OUTGOING - 11333509897252', 'narr3': '11333509897252'}, 'refNum': 'SDC231656', 'counter': '10', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3493946.46, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00073080-تحويل استثماريB2B OUTGOING - 1133350989725211333509897252', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-23', 'postingTime': '16:00:48', 'valueDate': '2024-01-23', 'type': '59', 'amount': {'amount': -326.3, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'TM-MOB TXN NO : 247081000068', 'narr2': 'Telemoney transactions from Digital'}, 'refNum': 'SDC231657', 'counter': '11', 'stmt': 'Y', 'srcAcctNum': 'I013253401840200', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3494272.76, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I013253401840200', 'samaNarr': 'TM-MOB TXN NO : 247081000068Telemoney transactions from Digital', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '016DC'}, {'postDate': '2024-01-23', 'postingTime': '16:01:38', 'valueDate': '2024-01-23', 'type': '59', 'amount': {'amount': -306.6, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'TM-MOB TXN NO : 247081000069', 'narr2': 'Telemoney transactions from Digital'}, 'refNum': 'SDC231658', 'counter': '12', 'stmt': 'Y', 'srcAcctNum': 'I013253401840200', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3494579.36, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I013253401840200', 'samaNarr': 'TM-MOB TXN NO : 247081000069Telemoney transactions from Digital', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '016DC'}, {'postDate': '2024-01-23', 'postingTime': '16:30:43', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': 50, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073086-تحويل استثماري', 'narr2': 'B2B OUTGOING - 7715193630519', 'narr3': '7715193630519'}, 'refNum': 'SDC231681', 'counter': '13', 'stmt': 'Y', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': -3494529.36, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00073086-تحويل استثماريB2B OUTGOING - 77151936305197715193630519', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-23', 'postingTime': '16:31:09', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': 5, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073087-تحويل استثماري', 'narr2': 'B2B OUTGOING - 5149021363520', 'narr3': '5149021363520'}, 'refNum': 'SDC231682', 'counter': '14', 'stmt': 'Y', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': -3494524.36, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00073087-تحويل استثماريB2B OUTGOING - 51490213635205149021363520', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-23', 'postingTime': '16:35:32', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': -52.15, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073088', 'narr2': 'B2B OUTGOING - 4182247781521', 'narr3': '4182247781521'}, 'refNum': 'SDC231683', 'counter': '15', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3494576.51, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00073088B2B OUTGOING - 41822477815214182247781521', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23168423-01-2024   2', 'postDate': '2024-01-23', 'postingTime': '16:36:29', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': 51, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240123SAARNBARNB1B11211632415858', 'narr2': 'BT00073088', 'narr3': 'AC02'}, 'refNum': 'SDC231684', 'counter': '16', 'stmt': 'Y', 'srcAcctNum': 'I011660101031051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': -3494525.51, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I011660101031051', 'samaNarr': '20240123SAARNBARNB1B11211632415858BT00073088AC02', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23168423-01-2024   2', 'postDate': '2024-01-23', 'postingTime': '16:39:57', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': -23.15, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073089', 'narr2': 'B2B OUTGOING - 5648994528523', 'narr3': '5648994528523'}, 'refNum': 'SDC231687', 'counter': '17', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3494548.66, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00073089B2B OUTGOING - 56489945285235648994528523', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23168923-01-2024   2', 'postDate': '2024-01-23', 'postingTime': '16:40:33', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': 22, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240123SAARNBARNB1B58711637415969', 'narr2': 'BT00073089', 'narr3': 'AC02'}, 'refNum': 'SDC231689', 'counter': '18', 'stmt': 'Y', 'srcAcctNum': 'I011660101031051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': -3494526.66, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I011660101031051', 'samaNarr': '20240123SAARNBARNB1B58711637415969BT00073089AC02', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23168923-01-2024   2', 'postDate': '2024-01-23', 'postingTime': '17:46:57', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': -18.15, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073092', 'narr2': 'B2B OUTGOING - 8965001208528', 'narr3': '8965001208528'}, 'refNum': 'SDC231702', 'counter': '19', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': -3494544.81, 'currencyCode': 'SAR'}, 'orderingParty': 'SAMIR ELSAID SHARAF SALMAN', 'samaNarr': 'BT00073092B2B OUTGOING - 89650012085288965001208528', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23170523-01-2024   2', 'postDate': '2024-01-23', 'postingTime': '17:48:08', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': 17, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240123SAARNBARNB1B66411744417602', 'narr2': 'BT00073092', 'narr3': 'AC02'}, 'refNum': 'SDC231705', 'counter': '20', 'stmt': 'Y', 'srcAcctNum': 'I011660101031051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': -3494527.81, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SAMIR ELSAID SHARAF SALMAN', 'iban': 'I011660101031051', 'samaNarr': '20240123SAARNBARNB1B66411744417602BT00073092AC02', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}]}}, {'accountNumber': '0108057386290014', 'fromDate': '2024-01-22', 'toDate': '2024-01-29', 'numberOfRecords': 20, 'completed': False, 'offset': '23-01-2024SDC231584      1   23-01-202415:28:400000000491999303.89', 'broughtFrwdBalance': {'amount': 491960301.42, 'currencyCode': 'SAR'}, 'openingClrBalance': {'amount': 491960301.42}, 'pageOpenBalance': {'amount': 491960301.42, 'currencyCode': 'SAR'}, 'closingBalance': {'amount': 491999303.89, 'currencyCode': 'SAR'}, 'statement': {'transactions': [{'postDate': '2024-01-29', 'postingTime': '18:33:54', 'valueDate': '2024-01-29', 'type': '56', 'amount': {'amount': 50000, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00039892-Investment transaction', 'narr2': '123170185993585', 'narr3': '17018768262951'}, 'refNum': 'SDC216350', 'counter': '1', 'stmt': 'N', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 492010301.42, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00039892-Investment transaction12317018599358517018768262951', 'network': '01', 'channel': 'ANB'}, {'postDate': '2024-01-22', 'postingTime': '19:40:06', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -101.15, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073011', 'narr2': 'ANB to Local Banks transfer', 'narr3': '6534664105'}, 'refNum': 'SDC231322', 'counter': '2', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010200.27, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073011ANB to Local Banks transfer6534664105', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23132322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '19:40:15', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 100, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240122SAARNBARNB1B81211937383237', 'narr2': 'BT00073011', 'narr3': 'AC02'}, 'refNum': 'SDC231323', 'counter': '3', 'stmt': 'N', 'srcAcctNum': 'I011660101461051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 492010300.27, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'iban': 'I011660101461051', 'samaNarr': '20240122SAARNBARNB1B81211937383237BT00073011AC02', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23132322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '08:22:06', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -101.15, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073014', 'narr2': 'ANB to Local Banks transfer', 'narr3': '6534664106'}, 'refNum': 'SDC231424', 'counter': '4', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010199.12, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073014ANB to Local Banks transfer6534664106', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23142522-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '08:22:34', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 100, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240123SAARNBARNB1B14910819402435', 'narr2': 'BT00073014', 'narr3': 'AC02'}, 'refNum': 'SDC231425', 'counter': '5', 'stmt': 'N', 'srcAcctNum': 'I011660101461051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 492010299.12, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'iban': 'I011660101461051', 'samaNarr': '20240123SAARNBARNB1B14910819402435BT00073014AC02', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23142522-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '10:58:10', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -843.1, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073023', 'narr2': 'ANB to Local Banks transfer', 'narr3': '3812978684'}, 'refNum': 'SDC231463', 'counter': '6', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492009456.02, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073023ANB to Local Banks transfer3812978684', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23146422-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '10:58:32', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 842.53, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240123SAARNBARNB1B12711055406357', 'narr2': 'BT00073023', 'narr3': 'AC02'}, 'refNum': 'SDC231464', 'counter': '7', 'stmt': 'N', 'srcAcctNum': 'I011660101461051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 492010298.55, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'iban': 'I011660101461051', 'samaNarr': '20240123SAARNBARNB1B12711055406357BT00073023AC02', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23146422-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '11:16:17', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -4.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073026-مدفوعات تجارية', 'narr2': 'ANB To ANB Transfer', 'narr3': '135'}, 'refNum': 'SDC231475', 'counter': '8', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010294.1, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073026-مدفوعات تجاريةANB To ANB Transfer135', 'network': '01', 'channel': 'ANB'}, {'uniqueId': 'SDC23146422-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '11:17:46', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -4.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073027-مدفوعات تجارية', 'narr2': 'ANB To ANB Transfer', 'narr3': '136'}, 'refNum': 'SDC231476', 'counter': '9', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010289.65, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073027-مدفوعات تجاريةANB To ANB Transfer136', 'network': '01', 'channel': 'ANB'}, {'uniqueId': 'SDC23146422-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '12:10:38', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -43.65, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073039', 'narr2': 'ANB to Local Banks transfer', 'narr3': '7858840963'}, 'refNum': 'SDC231492', 'counter': '10', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010246, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073039ANB to Local Banks transfer7858840963', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '12:11:16', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': 42.5, 'currencyCode': 'SAR'}, 'narrative': {'narr1': '20240123SAARNBARNB1B92911208408702', 'narr2': 'BT00073039', 'narr3': 'AC02'}, 'refNum': 'SDC231493', 'counter': '11', 'stmt': 'N', 'srcAcctNum': 'I011660101461051', 'partTrnType': 'CREDIT', 'partTrnSrlNum': '2', 'runningBalance': {'amount': 492010288.5, 'currencyCode': 'SAR'}, 'beneficiaryName': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'iban': 'I011660101461051', 'samaNarr': '20240123SAARNBARNB1B92911208408702BT00073039AC02', 'network': '01', 'channel': 'ANB', 'category': '000SJ', 'subCategory': 'SJBB6', 'prtclrsCode': 'SJBB6'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '12:15:20', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -18.05, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073040-مدفوعات تجارية', 'narr2': 'RawandTestt', 'narr3': '862365'}, 'refNum': 'SDC231494', 'counter': '12', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010270.45, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073040-مدفوعات تجاريةRawandTestt862365', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '01603'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '13:48:23', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -18.05, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073048-مدفوعات تجارية', 'narr2': 'RawandTestt', 'narr3': '452369'}, 'refNum': 'SDC231513', 'counter': '13', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010252.4, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073048-مدفوعات تجاريةRawandTestt452369', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '01603'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '13:55:35', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -18.05, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073049-مدفوعات تجارية', 'narr2': 'RawandTestt', 'narr3': '342370'}, 'refNum': 'SDC231514', 'counter': '14', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010234.35, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073049-مدفوعات تجاريةRawandTestt342370', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '01603'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '13:58:56', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -18.05, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073050-مدفوعات تجارية', 'narr2': 'RawandTestt', 'narr3': '452371'}, 'refNum': 'SDC231515', 'counter': '15', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010216.3, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073050-مدفوعات تجاريةRawandTestt452371', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '01603'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '14:04:31', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -13.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073051-مدفوعات تجارية', 'narr2': 'RawandTestt', 'narr3': '112384'}, 'refNum': 'SDC231516', 'counter': '16', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010202.85, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073051-مدفوعات تجاريةRawandTestt112384', 'network': '01', 'channel': 'ANB'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '14:05:44', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -26.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073053-مدفوعات تجارية', 'narr2': 'RawandTestt', 'narr3': '752386'}, 'refNum': 'SDC231517', 'counter': '17', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010176.4, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073053-مدفوعات تجاريةRawandTestt752386', 'network': '01', 'channel': 'ANB'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-22', 'postingTime': '14:05:46', 'valueDate': '2024-01-22', 'type': '56', 'amount': {'amount': -18.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073052-مدفوعات تجارية', 'narr2': 'RawandTestt', 'narr3': '572385'}, 'refNum': 'SDC231518', 'counter': '18', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492010157.95, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073052-مدفوعات تجاريةRawandTestt572385', 'network': '01', 'channel': 'ANB'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-23', 'postingTime': '14:57:07', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': -10003.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073059-تحويل استثماري', 'narr2': 'B2B OUTGOING - 371', 'narr3': '371'}, 'refNum': 'SDC231549', 'counter': '19', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 492000154.5, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073059-تحويل استثماريB2B OUTGOING - 371371', 'network': '01', 'channel': 'ANB'}, {'uniqueId': 'SDC23149322-01-2024   2', 'postDate': '2024-01-23', 'postingTime': '15:28:40', 'valueDate': '2024-01-23', 'type': '56', 'amount': {'amount': -850.61, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00073060', 'narr2': 'ANB to Local Banks transfer', 'narr3': '5974835616'}, 'refNum': 'SDC231584', 'counter': '20', 'stmt': 'N', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 491999303.89, 'currencyCode': 'SAR'}, 'orderingParty': 'SENTHIL KUMAR ANDI NADAR MURUGESAN', 'samaNarr': 'BT00073060ANB to Local Banks transfer5974835616', 'network': '01', 'channel': 'ANB', 'prtclrsCode': '16IPI'}]}}, {'accountNumber': '0108050053560021', 'fromDate': '2024-01-22', 'toDate': '2024-01-29', 'numberOfRecords': 1, 'completed': True, 'offset': '29-01-2024SDC216350      1   29-01-202418:33:540000168367286668.95', 'broughtFrwdBalance': {'amount': 168367336672.4, 'currencyCode': 'SAR'}, 'openingClrBalance': {'amount': 168367336672.4}, 'pageOpenBalance': {'amount': 168367336672.4, 'currencyCode': 'SAR'}, 'closingBalance': {'amount': 168367286668.95, 'currencyCode': 'SAR'}, 'statement': {'transactions': [{'postDate': '2024-01-29', 'postingTime': '18:33:54', 'valueDate': '2024-01-29', 'type': '56', 'amount': {'amount': -50003.45, 'currencyCode': 'SAR'}, 'narrative': {'narr1': 'BT00039892-Investment transaction', 'narr2': '123170185993585', 'narr3': '17018768262951'}, 'refNum': 'SDC216350', 'counter': '1', 'stmt': 'Y', 'partTrnType': 'DEBIT', 'partTrnSrlNum': '1', 'runningBalance': {'amount': 168367286668.95, 'currencyCode': 'SAR'}, 'orderingParty': 'DA.NISH TANVEE_R NASEER AFTAB', 'samaNarr': 'BT00039892-Investment transaction12317018599358517018768262951', 'network': '01', 'channel': 'ANB'}]}}, {'accountNumber': '0108066503320022', 'fromDate': '2024-01-22', 'toDate': '2024-01-29', 'numberOfRecords': 0, 'completed': False, 'broughtFrwdBalance': {'amount': 0, 'currencyCode': 'SAR'}, 'openingClrBalance': {'amount': 0}, 'pageOpenBalance': {'amount': 0, 'currencyCode': 'SAR'}, 'closingBalance': {'amount': 0, 'currencyCode': 'SAR'}, 'statement': None}]
    settings = frappe.get_doc("ANB Settings")
    response = json.loads(settings.start_connection().text)
    headers = {
        "Authorization": f"Bearer {response['access_token']}",
        "Accept": "application/json"
    }
    results = []
    for account in settings.accounts:
        results.append(get_account_statment(account.account_number, settings, True, headers))
    return results

@frappe.whitelist()
def check_latest_failed_logs(account_number):
    last_doc = frappe.get_list("Anb Log Queue", filters=[["account_number", "=", account_number], ["docstatus", "=", 1]], fields=['name', 'status'], order_by='creation desc', limit=1)
    failed_transactions = []
    if isinstance(last_doc, list) and len(last_doc) == 1:
        if last_doc[0].status == "Failed":
            frappe.db.set_value("Anb Log Queue", last_doc[0].name, "status", "Discarded")
        failed_payments = []
        if last_doc[0].status != "Completed":
            failed_payments = frappe.get_list("Anb Payment Log", filters={"status": "Failed", "log_queue": last_doc[0].name}, fields=["transaction_number"])
        if failed_payments:
            for payment in failed_payments:
                failed_transactions.append(payment.transaction_number)
    return failed_transactions

@frappe.whitelist()
def make_bank_logs():
    bank_responses = get_statments()
    for bank_response in bank_responses:
        company_account_number = bank_response.get("accountNumber")
        if isinstance(bank_response, dict) and bank_response.get("statement") and bank_response.get("statement").get("transactions"):
            failed_transactions = check_latest_failed_logs(company_account_number)
            transactions = bank_response.get("statement").get("transactions")
            (mode_of_payment, company, currency) = frappe.db.get_value("Anb Settings Table", [["account_number", "=", company_account_number]], ["mode_of_payment", "company", "currency"])
            queue = frappe.get_doc(dict(
                doctype = "Anb Log Queue",
                posting_date = today(),
                posting_time = nowtime(),
                company = company,
                account_number = company_account_number
            )).insert()
            queue_logs = []
            for transaction in transactions:
                if (not frappe.db.get_value("Anb Payment Table", [["transaction_number", "=", transaction["refNum"]], ["docstatus", "=", 1]]) 
                    or transaction["refNum"] in failed_transactions
                ):
                    customer = frappe.db.get_value("Customer", [["anb_bank_account", "=", transaction.get("srcAcctNum") or ""]], ["name", "anb_bank_account"], as_dict=True)
                    if transaction.get("srcAcctNum"):
                        failed_log = frappe.db.get_value("Anb Payment Log", [[ "transaction_number", "=", transaction["refNum"]], ["status", "=", "Failed"]], ["name", "status"], as_dict=True)
                        payment_log = frappe.get_doc(dict(
                            doctype = "Anb Payment Log",
                            company = company,
                            transaction_number = transaction["refNum"],
                            customer_name = customer.name if customer else "",
                            bank_account_number = customer.anb_bank_account if customer else transaction.get("srcAcctNum"),
                            company_account_number = bank_response.get("accountNumber"),
                            date = transaction["valueDate"],
                            time = transaction["postingTime"],
                            amount = transaction["amount"].get("amount"),
                            currency= transaction["amount"].get("currencyCode"),
                            dflt_currency = currency,
                            channel= transaction["channel"],
                            network= transaction["network"],
                            type = transaction["type"],
                            mode_of_payment = mode_of_payment,
                            log_queue = queue.name,
                            log= str(transaction),
                            failed_log= failed_log.name if failed_log else ""   
                        )).insert()
                        if failed_log:
                            frappe.db.set_value("Anb Payment Log", failed_log.name, "status", "Discarded")
                        payment_log.flags.ignore_links = True
                        payment_log.submit()
                        queue_logs.append(dict(
                            transaction_number = transaction["refNum"],
                            payment_log = payment_log.name
                        ))
            if queue_logs:
                queue.set("logs", queue_logs)
                queue.submit()
            else:
                queue.delete()

